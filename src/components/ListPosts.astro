---
interface Props {
  count?: number;
  filterTag?: string; // normalized slug to filter by, e.g. "context-engineering" or "uncategorized"
}

import { getCollection } from "astro:content";
import { toFriendlyDate } from "../utils/dates";
import { slugifyTag } from "../utils/slugify";
import TagBadge from "./TagBadge.astro";

const { count, filterTag } = Astro.props as Props;

const allPosts = (await getCollection("posts")).sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

const posts = allPosts.filter((post, index) => {
  if (import.meta.env.PROD && post.data.draft) {
    return false;
  }

  if (filterTag) {
    if (filterTag === "uncategorized") {
      return !(post.data.tags && post.data.tags.length > 0);
    }
    const postHasTag = (post.data.tags || []).some((t) => slugifyTag(t) === filterTag);
    return postHasTag;
  }

  if (count && count > 0) {
    return index < count;
  }
  return true;
});

const imageHeight = 80;
---

<section class="row">
  {
    posts.map((post) => (
      <div class="col-12 col-lg-6">
        <div class="card mb-4">
          {post.data.thumbnail && (
            <div class="card-header">
              <img
                src={post.data.thumbnail.src}
                alt={post.data.thumbnail.alt}
                class="card-img-top"
                style={{
                  "max-height": `${imageHeight}px`,
                  "height": `${imageHeight}px`,
                  "object-fit": "contain",
                }}
              />
            </div>
          )}
          <div class="card-body">
            <h5 class="card-title mb-3">
              <a href={`/${post.id}`} class="text-decoration-none">
                {post.data.title}
              </a>
            </h5>
            <h6 class="card-subtitle text-secondary mb-4">{toFriendlyDate(post.data.date)}</h6>
            <p class="card-text">{post.data.description}</p>
            <div class="mt-2">
              {post.data.tags && post.data.tags.length > 0 ? post.data.tags.map((t: string) => <TagBadge tag={t} />) : <TagBadge tag="Uncategorized" />}
            </div>
          </div>
        </div>
      </div>
    ))
  }
</section>
