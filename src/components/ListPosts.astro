---
interface Props {
  count?: number;
  filterTag?: string; // normalized slug to filter by, e.g. "context-engineering" or "uncategorized"
}

import TagBadge from "@/components/TagBadge.astro";
import { toFriendlyDate } from "@/utils/dates";
import { filterByCount, filterByDate, filterByDraft, filterByTag, getAllPosts, sortPostsByDate } from "@/utils/posts";

const { count, filterTag } = Astro.props as Props;

const posts = (await getAllPosts())
  .sort(sortPostsByDate())
  .filter(filterByDraft())
  .filter(filterByDate(new Date()))
  .filter(filterByTag(filterTag))
  .filter(filterByCount(count));

const imageHeight = 80;
---

<section class="row">
  {
    posts.map((post) => (
      <div class="col-12 col-md-6 col-xl-4">
        <div class="card mb-4">
          {post.data.thumbnail && (
            <div class="card-header">
              <img
                src={post.data.thumbnail.src}
                alt={post.data.thumbnail.alt}
                class="card-img-top"
                style={{
                  "max-height": `${imageHeight}px`,
                  "height": `${imageHeight}px`,
                  "object-fit": "contain",
                }}
              />
            </div>
          )}
          <div class="card-body">
            <h5 class="card-title mb-3">
              <a href={`/${post.id}`} class="text-decoration-none">
                {post.data.title}
              </a>
            </h5>
            <h6 class="card-subtitle mb-2">{toFriendlyDate(post.data.date)}</h6>
            <p class="card-text">{post.data.description}</p>
            <div class="mt-2">
              {post.data.tags && post.data.tags.length > 0 ? post.data.tags.map((t: string) => <TagBadge tag={t} />) : <TagBadge tag="Uncategorized" />}
            </div>
          </div>
        </div>
      </div>
    ))
  }
</section>
